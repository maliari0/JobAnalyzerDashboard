<div class="job-detail-container">
  <button class="back-button" (click)="goBack()">
    <span>&larr;</span> Geri DÃ¶n
  </button>

  <div *ngIf="loading" class="loading">
    <p>YÃ¼kleniyor...</p>
  </div>

  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
    <button *ngIf="job" (click)="clearError()" class="retry-button">Tekrar Dene</button>
  </div>

  <div *ngIf="emailContentError" class="error-message">
    <p>{{ emailContentError }}</p>
    <button (click)="emailContentError = ''" class="retry-button">Kapat</button>
  </div>

  <div *ngIf="!loading && !error && job" class="job-detail-card">
    <div class="job-header">
      <div class="job-title-container">
        <h1>{{ job.title }}</h1>
        <button *ngIf="isAdmin" class="delete-button" (click)="deleteJob()" title="Ä°ÅŸ ilanÄ±nÄ± sil">
          <span class="delete-icon">ğŸ—‘ï¸</span>
        </button>
      </div>
      <div class="job-badges">
        <span class="quality-badge" [ngClass]="getQualityScoreClass(job.qualityScore)">
          Kalite: {{ job.qualityScore }}/5
        </span>
        <span class="action-badge" [ngClass]="getActionSuggestionClass(job.actionSuggestion)">
          {{ getActionSuggestionText(job.actionSuggestion) }}
        </span>
      </div>
    </div>

    <div class="job-company-info">
      <div>
        <h3>{{ job.company }}</h3>
        <p class="job-location">{{ job.location }}</p>
      </div>
      <div class="job-links" *ngIf="job.companyWebsite || job.url">
        <a *ngIf="job.companyWebsite" [href]="formatUrl(job.companyWebsite)" target="_blank" class="company-link">Firma Web Sitesi</a>
        <a *ngIf="job.url" [href]="formatUrl(job.url)" target="_blank" class="job-link">Ä°lan SayfasÄ±</a>
      </div>
    </div>

    <div class="job-tags" *ngIf="job.parsedTags && job.parsedTags.length > 0">
      <span class="tag" *ngFor="let tag of job.parsedTags">{{ tag }}</span>
    </div>

    <div class="job-meta-info">
      <div class="meta-item">
        <span class="meta-label">Kategori:</span>
        <span class="meta-value category-badge">{{ job.category }}</span>
      </div>

      <div class="meta-item">
        <span class="meta-label">Ã‡alÄ±ÅŸma Åekli:</span>
        <span class="meta-value">{{ job.employmentType }}</span>
      </div>

      <div class="meta-item">
        <span class="meta-label">MaaÅŸ AralÄ±ÄŸÄ±:</span>
        <span class="meta-value">{{ job.salary }}</span>
      </div>

      <div class="meta-item">
        <span class="meta-label">YayÄ±nlanma Tarihi:</span>
        <span class="meta-value">{{ job.postedDate | date:'dd/MM/yyyy' }}</span>
      </div>

      <div *ngIf="job.applicationDeadline" class="meta-item">
        <span class="meta-label">Son BaÅŸvuru Tarihi:</span>
        <span class="meta-value">{{ job.applicationDeadline | date:'dd/MM/yyyy' }}</span>
      </div>

      <div class="meta-item">
        <span class="meta-label">Kaynak:</span>
        <span class="meta-value source-badge">{{ job.source }}</span>
      </div>

      <div *ngIf="job.contactEmail" class="meta-item">
        <span class="meta-label">Ä°letiÅŸim:</span>
        <a [href]="'mailto:' + job.contactEmail" class="meta-value email-link">{{ job.contactEmail }}</a>
      </div>
    </div>

    <div class="job-description">
      <h3>AÃ§Ä±klama</h3>
      <p>{{ job.description }}</p>
    </div>

    <div class="job-actions">
      <div *ngIf="!job.isApplied && !applyingInProgress" class="action-buttons">
        <button
          (click)="toggleApplicationForm()"
          class="apply-button"
        >
          <span>Manuel BaÅŸvur</span>
        </button>

        <button
          (click)="autoApply()"
          class="auto-apply-button"
          title="n8n webhook'unu tetikleyerek otomatik baÅŸvuru e-postasÄ± oluÅŸturur"
        >
          <span>Otomatik OluÅŸtur</span>
        </button>
      </div>

      <div *ngIf="applyingInProgress" class="applying-info">
        <span class="applying-badge">BaÅŸvuruluyor...</span>
        <p class="applying-message">LÃ¼tfen bekleyin, baÅŸvuru e-postasÄ± oluÅŸturuluyor...</p>
      </div>

      <div *ngIf="job.isApplied && !applyingInProgress" class="applied-info">
        <span class="applied-badge">BaÅŸvuruldu</span>
        <span *ngIf="job.appliedDate" class="applied-date">
          BaÅŸvuru Tarihi: {{ job.appliedDate | date:'dd/MM/yyyy' }}
        </span>
      </div>
    </div>

    <!-- BaÅŸvuru Formu -->
    <div *ngIf="showApplicationForm && !job.isApplied" class="application-form">
      <h3>BaÅŸvuru Formu</h3>

      <div class="form-group">
        <label for="applicationMessage">BaÅŸvuru MesajÄ±:</label>
        <textarea
          id="applicationMessage"
          [(ngModel)]="applicationMessage"
          rows="6"
          placeholder="BaÅŸvuru mesajÄ±nÄ±zÄ± giriniz..."
        ></textarea>
      </div>

      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" [(ngModel)]="cvAttached">
          Ã–zgeÃ§miÅŸ Ekle
        </label>
      </div>

      <div class="form-actions">
        <button
          (click)="applyToJob()"
          [disabled]="applyingInProgress || !applicationMessage"
          class="submit-button"
        >
          <span *ngIf="!applyingInProgress">BaÅŸvuruyu GÃ¶nder</span>
          <span *ngIf="applyingInProgress">GÃ¶nderiliyor...</span>
        </button>
        <button (click)="toggleApplicationForm()" class="cancel-button">VazgeÃ§</button>
      </div>
    </div>
  </div>

  <!-- E-posta Ä°Ã§eriÄŸi Modal -->
  <div *ngIf="showEmailModal" class="email-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Otomatik OluÅŸturulan E-posta Ä°Ã§eriÄŸi</h3>
        <button class="close-button" (click)="closeEmailModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div *ngIf="loadingEmailContent" class="loading-email">
          <p>E-posta iÃ§eriÄŸi yÃ¼kleniyor...</p>
        </div>

        <div *ngIf="!loadingEmailContent && emailContent" class="email-content">
          <p><strong>Ä°ÅŸ Ä°lanÄ±:</strong> {{ job?.title }}</p>
          <p><strong>Åirket:</strong> {{ job?.company }}</p>

          <div class="email-text-container">
            <h4>E-posta Ä°Ã§eriÄŸi:</h4>
            <div class="email-text">
              <textarea [(ngModel)]="emailContent" rows="10" class="email-textarea"></textarea>
            </div>
          </div>

          <p class="email-info">
            Bu e-posta iÃ§eriÄŸi yapay zeka tarafÄ±ndan otomatik olarak oluÅŸturulmuÅŸtur.
            Ä°Ã§eriÄŸi dÃ¼zenleyebilir ve "E-posta GÃ¶nder" butonuna tÄ±klayarak gÃ¶nderebilirsiniz.
            AyrÄ±ca, bu iÃ§eriÄŸi BaÅŸvuru GeÃ§miÅŸi sayfasÄ±ndan da gÃ¶rÃ¼ntÃ¼leyebilirsiniz.
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button
          class="send-email-button"
          [disabled]="sendingEmail"
          (click)="sendEmail()"
          *ngIf="emailContent"
        >
          <span *ngIf="!sendingEmail">E-posta GÃ¶nder</span>
          <span *ngIf="sendingEmail">GÃ¶nderiliyor...</span>
        </button>
        <button class="close-button-footer" (click)="closeEmailModal()">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Modal Arka Plan -->
  <div *ngIf="showEmailModal" class="modal-backdrop" (click)="closeEmailModal()"></div>
</div>
